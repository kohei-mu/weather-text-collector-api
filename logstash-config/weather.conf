input {
    http_poller {
        urls => {
            tokyo => {
                url     => "http://api.openweathermap.org/data/2.5/weather?q=Tokyo,JP&units=metric&appid=${OPENWEATHER_AUTH}"
                headers => { Accept => "application/json" }
            }
            osaka => {
                url     => "http://api.openweathermap.org/data/2.5/weather?q=Osaka,JP&units=metric&appid=${OPENWEATHER_AUTH}"
                headers => { Accept => "application/json" }
            }
            taipei => {
                url     => "http://api.openweathermap.org/data/2.5/weather?q=Taipei,TW&units=metric&appid=${OPENWEATHER_AUTH}"
                headers => { Accept => "application/json" }
            }
            taichung => {
                    url     => "http://api.openweathermap.org/data/2.5/weather?q=Taichung,TW&units=metric&appid=${OPENWEATHER_AUTH}"
                    headers => { Accept => "application/json" }
            }
            tainan => {
                url     => "http://api.openweathermap.org/data/2.5/weather?q=Tainan,TW&units=metric&appid=${OPENWEATHER_AUTH}"
                headers => { Accept => "application/json" }
            }
            beijing => {                                        
                url     => "http://api.openweathermap.org/data/2.5/weather?q=Beijing,CN&units=metric&appid=${OPENWEATHER_AUTH}"
                headers => { Accept => "application/json" }
            }
            shanghai => {                                        
                url     => "http://api.openweathermap.org/data/2.5/weather?q=Shanghai,CN&units=metric&appid=${OPENWEATHER_AUTH}"
                headers => { Accept => "application/json" }
            }
            hongkong => {                                        
                url     => "http://api.openweathermap.org/data/2.5/weather?q=HongKong,HK&units=metric&appid=${OPENWEATHER_AUTH}"
                headers => { Accept => "application/json" }
            }
        }
        request_timeout => 60
        schedule        => { cron => "0 * * * *" }
        metadata_target => "weather_target_metadata"
        target          => "weather_target_data"
    }
}

filter {
    mutate {
        add_field => { 
            "temperature" => "%{[weather_target_data][main][temp]}"
            "humidity"    => "%{[weather_target_data][main][humidity]}"
            "pressure"    => "%{[weather_target_data][main][pressure]}"
            "country"     => "%{[weather_target_data][sys][country]}"
            "city"        => "%{[weather_target_data][name]}"
            "description" => "%{[weather_target_data][weather][0][description]}" 
        }
        convert => {
            "temperature" => "float"
            "humidity"    => "float"
            "pressure"    => "float"
        }
    }

    # 気象統計量計算API
    http {
        url  => "http://localhost:5000/hukai"
        verb => "POST"
        body => {
            "temp"  => "%{temperature}"
            "humid" => "%{humidity}"
        }
        body_format => "json"
        target_body => "[hukai_response]"
        headers => { "Content-Type" => "application/json" } 
    }
    http {
        url => "http://localhost:5000/kanso"
        verb => "POST"
        body => {
            "humid" => "%{humidity}"
        }
        body_format => "json"
        target_body => "[kanso_response]"
        headers => { "Content-Type" => "application/json" }
    }

    # ジオハッシュ計算API
    http {
        url => "http://localhost:5000/geohash"
        verb => "POST"
        body => {
            "lat" => "%{[weather_target_data][coord][lat]}" 
            "lon" => "%{[weather_target_data][coord][lon]}"
        }
        body_format => "json"
        target_body => "[geohash_response]"
        headers => { "Content-Type" => "application/json" }
    }

    mutate {
        add_field => {
            "hukai"   => "%{[hukai_response][hukai]}"
            "kanso"   => "%{[kanso_response][kanso]}"
            "tag"  => "%{city}_%{country}"
        }
        convert => {
            "hukai" => "float"
            "kanso" => "float"
        }
    }

    # 異常検知API
    http {
        url => "http://localhost:5000/anomaly"
        verb => "POST"
        body => {
            "value" => "%{temperature}"
            "tag" => "temperature_%{tag}"
        }
        body_format => "json"
        target_body => "[temperature_anomaly_response]"
        headers => { "Content-Type" => "application/json" }
    }
    http {
        url => "http://localhost:5000/anomaly"
        verb => "POST"
        body => {
            "value" => "%{humidity}"
            "tag" => "humidity_%{tag}"
        }
        body_format => "json"
        target_body => "[humidity_anomaly_response]"
        headers => { "Content-Type" => "application/json" }
    }
    http {
        url => "http://localhost:5000/anomaly"
        verb => "POST"
        body => {
            "value" => "%{pressure}"
            "tag" => "pressure_%{tag}"
        }
        body_format => "json"
        target_body => "[pressure_anomaly_response]"
        headers => { "Content-Type" => "application/json" }
    }
    http {
        url => "http://localhost:5000/anomaly"
        verb => "POST"
        body => {
            "value" => "%{kanso}"
            "tag" => "kanso_%{tag}"
        }
        body_format => "json"
        target_body => "[kanso_anomaly_response]"
        headers => { "Content-Type" => "application/json" }
    }
    http {
        url => "http://localhost:5000/anomaly"
        verb => "POST"
        body => {
            "value" => "%{hukai}"
            "tag" => "hukai_%{tag}"
        }
        body_format => "json"
        target_body => "[hukai_anomaly_response]"
        headers => { "Content-Type" => "application/json" }
    }

    mutate {
        add_field => {
            "geohash"                   => "%{[geohash_response][geohash]}"
            "temperature_anomalyscore"  => "%{[temperature_anomaly_response][anomalyscore]}"
            "temperature_anomalyresult" => "%{[temperature_anomaly_response][anomalyresult]}"
            "humidity_anomalyscore"     => "%{[humidity_anomaly_response][anomalyscore]}"
            "humidity_anomalyresult"    => "%{[humidity_anomaly_response][anomalyresult]}"
            "pressure_anomalyscore"     => "%{[pressure_anomaly_response][anomalyscore]}"
            "pressure_anomalyresult"    => "%{[pressure_anomaly_response][anomalyresult]}"
            "kanso_anomalyscore"        => "%{[kanso_anomaly_response][anomalyscore]}"
            "kanso_anomalyresult"       => "%{[kanso_anomaly_response][anomalyresult]}"
            "hukai_anomalyscore"        => "%{[hukai_anomaly_response][anomalyscore]}"
            "hukai_anomalyresult"       => "%{[hukai_anomaly_response][anomalyresult]}"
        }
        remove_field => ["tag", "hukai_anomaly_response", "kanso_anomaly_response", "pressure_anomaly_response", "humidity_anomaly_response", "temperature_anomaly_response", "headers", "hukai_response", "kanso_response", "geohash_response", "@version", "weather_target_data", "weather_target_metadata"]
        convert => {
            "temperature_anomalyscore"  => "float"
            "temperature_anomalyresult" => "integer"
            "humidity_anomalyscore"     => "float"
            "humidity_anomalyresult"    => "integer"
            "pressure_anomalyscore"     => "float"
            "pressure_anomalyresult"    => "integer"
            "kanso_anomalyscore"        => "float"
            "kanso_anomalyresult"       => "integer"
            "hukai_anomalyscore"        => "float"
            "hukai_anomalyresult"       => "integer"
        }
    }
}

output {
    elasticsearch {
        hosts => "localhost"
        index => "weather"
    }
}
